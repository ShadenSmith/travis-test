#!/bin/bash


# parse arguments
for i in "${@}"; do
  case "${i}" in
    --with-precision=*)
      PRECISION=${i#*=}
      if [ "${PRECISION}" == "single" ]; then
        CONFIG_FLAGS="${CONFIG_FLAGS} -DFLT_WIDTH=single"
      elif [ "${PRECISION}" == "double" ]; then
        CONFIG_FLAGS="${CONFIG_FLAGS} -FLT_WIDTH=double"
      else
        die "Unknown precision: ${PRECISION}. Choose between {single,double}."
      fi
    ;;

    # bad argument
    *)
    die "Unknown option '${i}'"
    ;;
  esac
done


# clean out build directory if it exists
BUILDDIR=build
if [[ -d "${BUILDDIR}" ]]; then
  echo "Removing old build directory '${BUILDDIR}'..."
  rm -rf "${BUILDDIR}"
fi

# create build directory
mkdir -vp "${BUILDDIR}" || \
    die "Failed to create build directory: '${BUILDDIR}'"

pushd ${BUILDDIR}


cmake ${CONFIG_FLAGS} ../ ; popd

# create proxy makefile
(
echo "#######################################################################"
echo "# Makefile generated by '$0' at $(date)"
echo "# Using flags:"
for d in ${CONFIG_FLAGS}; do
  echo "#	${d}"
done
echo "#######################################################################"
echo ""
echo "all clean test:"
echo "	make -C ${BUILDDIR} \$@ \$(MAKEFLAGS)"
echo ""
echo "distclean:"
echo "	rm -rf ${BUILDDIR} Makefile"
echo ""
) > Makefile
